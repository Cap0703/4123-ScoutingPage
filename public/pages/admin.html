<!doctype html>
<html>
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <title>User Management</title>
    <link rel="stylesheet" href="/css/style.css"/>
    <script src="/js/auth.js"></script>
</head>
<body>
<!-- Mobile navigation -->
<div class="mobile-nav">
  <button class="hamburger" onclick="toggleMenu()">☰</button>
  <div class="mobile-menu" id="mobileMenu">
  <button class="mobile-menu-close" onclick="toggleMenu()">×</button>
  <a href="/" onclick="toggleMenu()">Home</a>
  <a href="/pages/ondeck.html" onclick="toggleMenu()">Ondeck</a>
  <a href="/pages/match_scouting.html" onclick="toggleMenu()">Match Scouting</a>
  <a href="/pages/pit_scouting.html" onclick="toggleMenu()">Pit Scouting</a>
  <a href="/pages/team_summary.html" class="admin-only" onclick="toggleMenu()">Team Summary</a>
  <a href="/pages/match_simulator.html" onclick="toggleMenu()">Match Simulator</a>
  <a href="/pages/rankings.html" class="admin-only" onclick="toggleMenu()">Rankings</a>
  <a href="/pages/raw_match.html" onclick="toggleMenu()">Raw Match Data</a>
  <a href="/pages/raw_match_edit.html" class="admin-only" onclick="toggleMenu()">Raw Match Data Edit</a>
  <a href="/pages/raw_pit.html" onclick="toggleMenu()">Raw Pit Data</a>
  <a href="/pages/raw_pit_edit.html" class="admin-only" onclick="toggleMenu()">Raw Pit Data Edit</a>
  <a href="/pages/battery_manager.html" onclick="toggleMenu()">Battery Manager</a>
  <a href="/pages/csv_upload.html" class="admin-only" onclick="toggleMenu()">CSV Upload</a>
  <a href="/pages/config_creator.html" onclick="toggleMenu()">Config Creator</a>
  <a href="/pages/admin.html" class="admin-only" onclick="toggleMenu()">User Management</a>
  <a href="/pages/logout.html" onclick="toggleMenu()">Logout</a>
  </div>
</div>
<script>
// Mobile menu functionality
function toggleMenu() {
  const menu = document.getElementById('mobileMenu');
  const isOpening = !menu.classList.contains('open');
  menu.classList.toggle('open');
  document.body.classList.toggle('menu-open', isOpening);
  if (isOpening) {
    setTimeout(() => {
      menu.scrollTop = 0;
    }, 50);
  }
}

// Close menu when clicking outside
document.addEventListener('click', function(event) {
  const menu = document.getElementById('mobileMenu');
  const hamburger = document.querySelector('.hamburger');
  if (menu.classList.contains('open') && 
      !menu.contains(event.target) && 
      event.target !== hamburger) {
    toggleMenu();
  }
});

// Close menu on escape key
document.addEventListener('keydown', function(event) {
  if (event.key === 'Escape') {
    const menu = document.getElementById('mobileMenu');
    if (menu.classList.contains('open')) {
      toggleMenu();
    }
  }
});

// Prevent background scrolling when menu is open
document.addEventListener('touchmove', function(event) {
  const menu = document.getElementById('mobileMenu');
  if (menu.classList.contains('open')) {
    if (!menu.contains(event.target)) {
      event.preventDefault();
    }
  }
}, { passive: false });
</script>
<!-- Original navbar (hidden on mobile) -->
<nav class="navbar">
  <a href="/">Home</a>
  <a href="/pages/ondeck.html">Ondeck</a>
  <a href="/pages/match_scouting.html">Match Scouting</a>
  <a href="/pages/pit_scouting.html">Pit Scouting</a>
  <a href="/pages/team_summary.html" class="admin-only">Team Summary</a>
  <a href="/pages/match_simulator.html">Match Simulator</a>
  <a href="/pages/rankings.html" class="admin-only">Rankings</a>
  <a href="/pages/raw_match.html">Raw Match Data</a>
  <a href="/pages/raw_match_edit.html" class="admin-only">Raw Match Data Edit</a>
  <a href="/pages/raw_pit.html">Raw Pit Data</a>
  <a href="/pages/raw_pit_edit.html" class="admin-only">Raw Pit Data Edit</a>
  <a href="/pages/battery_manager.html">Battery Manager</a>
  <a href="/pages/csv_upload.html" class="admin-only">CSV Upload</a>
  <a href="/pages/config_creator.html">Config Creator</a>
  <a href="/pages/admin.html" class="admin-only">User Management</a>
  <a href="/pages/logout.html">Logout</a>
</nav>
<div class="container admin-only">
    <h1>User Management</h1>
    
    <div class="card">
        <h2>Add New User</h2>
        <form id="addUserForm">
            <div class="form-row">
                <label for="newUsername">Username</label>
                <input type="text" id="newUsername" required>
            </div>
            <div class="form-row">
                <label for="newPassword">Password</label>
                <input type="password" id="newPassword" required>
            </div>
            <div class="form-row">
                <label for="newRole">Role</label>
                <select id="newRole" required>
                    <option value="scout">Scout</option>
                    <option value="admin">Admin</option>
                </select>
            </div>
            <button type="submit" class="btn">Add User</button>
        </form>
    </div>
    
    <div class="card">
        <h2>Existing Users</h2>
        <table id="usersTable" class="table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Username</th>
                    <th>Role</th>
                    <th>Created At</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
</div>

<script>
// Wait for auth to be fully initialized
function waitForAuth() {
    return new Promise((resolve) => {
        if (window.auth && window.auth.isInitialized) {
            resolve();
        } else {
            setTimeout(() => waitForAuth().then(resolve), 100);
        }
    });
}

document.addEventListener('DOMContentLoaded', async () => {
    await waitForAuth();
    if (!auth.isAdmin()) {
        document.body.innerHTML = `
            <div class="container">
                <h2>Access Denied</h2>
                <p>You need administrator privileges to access this page.</p>
                <a href="/">Return to Home</a>
            </div>
        `;
        return;
    }
    await loadUsers();
    
    // Setup form submission
    document.getElementById('addUserForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const username = document.getElementById('newUsername').value;
        const password = document.getElementById('newPassword').value;
        const role = document.getElementById('newRole').value;
        
        try {
            const response = await fetch('/api/users', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    ...auth.getAuthHeader()
                },
                body: JSON.stringify({ username, password, role })
            });
            
            if (response.ok) {
                alert('User added successfully');
                document.getElementById('addUserForm').reset();
                await loadUsers();
            } else {
                const error = await response.json();
                alert('Error: ' + (error.error || 'Failed to add user'));
            }
        } catch (error) {
            alert('Failed to add user: ' + error.message);
        }
    });
});

async function loadUsers() {
    try {
        const response = await fetch('/api/users', {
            headers: auth.getAuthHeader()
        });
        
        if (response.ok) {
            const users = await response.json();
            const tbody = document.querySelector('#usersTable tbody');
            tbody.innerHTML = '';
            
            users.forEach(user => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${user.id}</td>
                    <td>${user.username}</td>
                    <td>${user.role}</td>
                    <td>${new Date(user.created_at).toLocaleDateString()}</td>
                    <td>
                        <button class="btn btn-red" onclick="deleteUser(${user.id})">Delete</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        } else {
            console.error('Failed to load users:', await response.text());
            alert('Failed to load users');
        }
    } catch (error) {
        console.error('Error loading users:', error);
        alert('Error loading users: ' + error.message);
    }
}

async function deleteUser(userId) {
    if (!confirm('Are you sure you want to delete this user?')) return;
    
    try {
        const response = await fetch(`/api/users/${userId}`, {
            method: 'DELETE',
            headers: auth.getAuthHeader()
        });
        
        if (response.ok) {
            alert('User deleted successfully');
            await loadUsers();
        } else {
            const error = await response.json();
            alert('Error: ' + (error.error || 'Failed to delete user'));
        }
    } catch (error) {
        alert('Failed to delete user: ' + error.message);
    }
}
</script>
</body>
</html>