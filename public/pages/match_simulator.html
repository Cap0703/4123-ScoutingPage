<!doctype html>
<html><head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Match Simulator</title>
<link rel="stylesheet" href="/css/style.css"/>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
</head>
<body>
<div class="mobile-nav">
  <button class="hamburger" onclick="toggleMenu()">☰</button>
  <div class="mobile-menu" id="mobileMenu">
    <button class="mobile-menu-close" onclick="toggleMenu()">×</button>
  <a href="/">Home</a>
  <a href="/pages/match_scouting.html">Match Scouting</a>
  <a href="/pages/pit_scouting.html">Pit Scouting</a>
  <a href="/pages/team_summary.html" class="admin-only">Team Summary</a>
  <a href="/pages/match_simulator.html">Match Simulator</a>
  <a href="/pages/rankings.html" class="admin-only">Rankings</a>
  <a href="/pages/raw_match.html">Raw Match Data</a>
  <a href="/pages/raw_match_edit.html" class="admin-only">Raw Match Data Edit</a>
  <a href="/pages/raw_pit.html">Raw Pit Data</a>
  <a href="/pages/raw_pit_edit.html" class="admin-only">Raw Pit Data Edit</a>
  <a href="/pages/csv_upload.html" class="admin-only">CSV Upload</a>
  <a href="/pages/config_creator.html">Config Creator</a>
  <a href="/pages/admin.html" class="admin-only">User Management</a>
  <a href="/pages/logout.html">Logout</a>
  </div>
</div>
<script>
// Mobile menu functionality
function toggleMenu() {
  const menu = document.getElementById('mobileMenu');
  const isOpening = !menu.classList.contains('open');
  menu.classList.toggle('open');
  document.body.classList.toggle('menu-open', isOpening);
  if (isOpening) {
    setTimeout(() => {
      menu.scrollTop = 0;
    }, 50);
  }
}

// Close menu when clicking outside
document.addEventListener('click', function(event) {
  const menu = document.getElementById('mobileMenu');
  const hamburger = document.querySelector('.hamburger');
  if (menu.classList.contains('open') && 
      !menu.contains(event.target) && 
      event.target !== hamburger) {
    toggleMenu();
  }
});

// Close menu on escape key
document.addEventListener('keydown', function(event) {
  if (event.key === 'Escape') {
    const menu = document.getElementById('mobileMenu');
    if (menu.classList.contains('open')) {
      toggleMenu();
    }
  }
});

// Prevent background scrolling when menu is open
document.addEventListener('touchmove', function(event) {
  const menu = document.getElementById('mobileMenu');
  if (menu.classList.contains('open')) {
    if (!menu.contains(event.target)) {
      event.preventDefault();
    }
  }
}, { passive: false });
</script>

<nav class="navbar">
  <a href="/">Home</a>
  <a href="/pages/match_scouting.html">Match Scouting</a>
  <a href="/pages/pit_scouting.html">Pit Scouting</a>
  <a href="/pages/team_summary.html" class="admin-only">Team Summary</a>
  <a href="/pages/match_simulator.html">Match Simulator</a>
  <a href="/pages/rankings.html" class="admin-only">Rankings</a>
  <a href="/pages/raw_match.html">Raw Match Data</a>
  <a href="/pages/raw_match_edit.html" class="admin-only">Raw Match Data Edit</a>
  <a href="/pages/raw_pit.html">Raw Pit Data</a>
  <a href="/pages/raw_pit_edit.html" class="admin-only">Raw Pit Data Edit</a>
  <a href="/pages/csv_upload.html" class="admin-only">CSV Upload</a>
  <a href="/pages/config_creator.html">Config Creator</a>
  <a href="/pages/admin.html" class="admin-only">User Management</a>
  <a href="/pages/logout.html">Logout</a>
</nav>
<div class="container">
  <h1>Match Simulator</h1>
  
  <div class="card">
    <h3>Match Setup</h3>
    <div class="form-row">
      <label>Blue Alliance</label>
      <div class="form-controls">
        <input type="number" id="blue1" placeholder="Team 1">
        <input type="number" id="blue2" placeholder="Team 2">
        <input type="number" id="blue3" placeholder="Team 3">
      </div>
    </div>
    <div class="form-row">
      <label>Red Alliance</label>
      <div class="form-controls">
        <input type="number" id="red1" placeholder="Team 1">
        <input type="number" id="red2" placeholder="Team 2">
        <input type="number" id="red3" placeholder="Team 3">
      </div>
    </div>
    <div class="center">
      <button id="simulate" class="btn btn-green">Simulate Match</button>
    </div>
  </div>
  
  <div id="results" class="card" style="display: none;">
    <h3>Simulation Results</h3>
    <div id="scoreDisplay"></div>
    <div style="height: 300px;">
      <canvas id="scoreChart"></canvas>
    </div>
  </div>
</div>
<footer>FRC 4123 Scouting • Config-driven • SQLite</footer>

<script>
let scoreChart = null;

document.getElementById('simulate').addEventListener('click', async function() {
  const blueTeams = [
    document.getElementById('blue1').value,
    document.getElementById('blue2').value,
    document.getElementById('blue3').value
  ].filter(t => t);
  
  const redTeams = [
    document.getElementById('red1').value,
    document.getElementById('red2').value,
    document.getElementById('red3').value
  ].filter(t => t);
  
  if (blueTeams.length === 0 || redTeams.length === 0) {
    alert('Please enter at least one team for each alliance');
    return;
  }
  
  try {
    // Get team averages
    const teamAverages = {};
    for (const team of [...blueTeams, ...redTeams]) {
      const response = await fetch(`/api/team/${team}/averages`);
      const data = await response.json();
      if (!data.error) {
        teamAverages[team] = data;
      }
    }
    
    // Calculate alliance scores
    let blueAuto = 0, blueTeleop = 0, blueEndgame = 0;
    let redAuto = 0, redTeleop = 0, redEndgame = 0;
    
    blueTeams.forEach(team => {
      const avg = teamAverages[team];
      if (avg) {
        blueAuto += avg.avg_auto;
        blueTeleop += avg.avg_teleop;
        blueEndgame += avg.avg_endgame;
      }
    });
    
    redTeams.forEach(team => {
      const avg = teamAverages[team];
      if (avg) {
        redAuto += avg.avg_auto;
        redTeleop += avg.avg_teleop;
        redEndgame += avg.avg_endgame;
      }
    });
    
    const blueTotal = blueAuto + blueTeleop + blueEndgame;
    const redTotal = redAuto + redTeleop + redEndgame;
    
    // Display results
    const resultsDiv = document.getElementById('results');
    resultsDiv.style.display = 'block';
    
    document.getElementById('scoreDisplay').innerHTML = `
      <div class="score-row">
        <div style="background: #007bff20; padding: 10px; border-radius: 5px;">
          <h4>Blue Alliance: ${Math.round(blueTotal)} points</h4>
          <div>Auto: ${blueAuto.toFixed(1)}</div>
          <div>Teleop: ${blueTeleop.toFixed(1)}</div>
          <div>Endgame: ${blueEndgame.toFixed(1)}</div>
        </div>
        <div style="background: #dc354520; padding: 10px; border-radius: 5px;">
          <h4>Red Alliance: ${Math.round(redTotal)} points</h4>
          <div>Auto: ${redAuto.toFixed(1)}</div>
          <div>Teleop: ${redTeleop.toFixed(1)}</div>
          <div>Endgame: ${redEndgame.toFixed(1)}</div>
        </div>
      </div>
      <h3 style="text-align: center; margin-top: 20px;">
        Predicted Winner: ${blueTotal > redTotal ? 'Blue Alliance' : 'Red Alliance'}
      </h3>
    `;
    
    // Create chart
    createScoreChart(blueAuto, blueTeleop, blueEndgame, redAuto, redTeleop, redEndgame);
    
  } catch (error) {
    console.error('Error simulating match:', error);
    alert('Error simulating match. Please try again.');
  }
});

function createScoreChart(blueAuto, blueTeleop, blueEndgame, redAuto, redTeleop, redEndgame) {
  const ctx = document.getElementById('scoreChart').getContext('2d');
  if (scoreChart) scoreChart.destroy();
  
  scoreChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: ['Auto', 'Teleop', 'Endgame', 'Total'],
      datasets: [
        {
          label: 'Blue Alliance',
          data: [blueAuto, blueTeleop, blueEndgame, blueAuto + blueTeleop + blueEndgame],
          backgroundColor: 'rgba(0, 123, 255, 0.5)',
          borderColor: 'rgba(0, 123, 255, 1)',
          borderWidth: 1
        },
        {
          label: 'Red Alliance',
          data: [redAuto, redTeleop, redEndgame, redAuto + redTeleop + redEndgame],
          backgroundColor: 'rgba(220, 53, 69, 0.5)',
          borderColor: 'rgba(220, 53, 69, 1)',
          borderWidth: 1
        }
      ]
    },
    options: {
      responsive: true,
      scales: {
        y: {
          beginAtZero: true,
          title: {
            display: true,
            text: 'Points'
          }
        }
      }
    }
  });
}
</script>

</body></html>