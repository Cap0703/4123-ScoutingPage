<!doctype html>
<html><head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Rankings</title>
<link rel="stylesheet" href="/css/style.css"/>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
</head>
<body>
<!-- Mobile navigation -->
<div class="mobile-nav">
  <button class="hamburger" onclick="toggleMenu()">☰</button>
  <div class="mobile-menu" id="mobileMenu">
  <button class="mobile-menu-close" onclick="toggleMenu()">×</button>
  <a href="/" onclick="toggleMenu()">Home</a>
  <a href="/pages/pit_procedures.html" onclick="toggleMenu()">Pit Procedures</a>
  <a href="/pages/ondeck.html" onclick="toggleMenu()">Ondeck</a>
  <a href="/pages/match_scouting.html" onclick="toggleMenu()">Match Scouting</a>
  <a href="/pages/pit_scouting.html" onclick="toggleMenu()">Pit Scouting</a>
  <a href="/pages/team_summary.html" class="admin-only" onclick="toggleMenu()">Team Summary</a>
  <a href="/pages/match_simulator.html" onclick="toggleMenu()">Match Simulator</a>
  <a href="/pages/rankings.html" class="admin-only" onclick="toggleMenu()">Rankings</a>
  <a href="/pages/raw_match.html" onclick="toggleMenu()">Raw Match Data</a>
  <a href="/pages/raw_match_edit.html" class="admin-only" onclick="toggleMenu()">Raw Match Data Edit</a>
  <a href="/pages/raw_pit.html" onclick="toggleMenu()">Raw Pit Data</a>
  <a href="/pages/raw_pit_edit.html" class="admin-only" onclick="toggleMenu()">Raw Pit Data Edit</a>
  <a href="/pages/battery_manager.html" onclick="toggleMenu()">Battery Manager</a>
  <a href="/pages/csv_upload.html" class="admin-only" onclick="toggleMenu()">CSV Upload</a>
  <a href="/pages/config_creator.html" onclick="toggleMenu()">Config Creator</a>
  <a href="/pages/admin.html" class="admin-only" onclick="toggleMenu()">User Management</a>
  <a href="/pages/logout.html" onclick="toggleMenu()">Logout</a>
  </div>
</div>
<script>
// Mobile menu functionality
function toggleMenu() {
  const menu = document.getElementById('mobileMenu');
  const isOpening = !menu.classList.contains('open');
  menu.classList.toggle('open');
  document.body.classList.toggle('menu-open', isOpening);
  if (isOpening) {
    setTimeout(() => {
      menu.scrollTop = 0;
    }, 50);
  }
}

// Close menu when clicking outside
document.addEventListener('click', function(event) {
  const menu = document.getElementById('mobileMenu');
  const hamburger = document.querySelector('.hamburger');
  if (menu.classList.contains('open') && 
      !menu.contains(event.target) && 
      event.target !== hamburger) {
    toggleMenu();
  }
});

// Close menu on escape key
document.addEventListener('keydown', function(event) {
  if (event.key === 'Escape') {
    const menu = document.getElementById('mobileMenu');
    if (menu.classList.contains('open')) {
      toggleMenu();
    }
  }
});

// Prevent background scrolling when menu is open
document.addEventListener('touchmove', function(event) {
  const menu = document.getElementById('mobileMenu');
  if (menu.classList.contains('open')) {
    if (!menu.contains(event.target)) {
      event.preventDefault();
    }
  }
}, { passive: false });
</script>
<!-- Original navbar (hidden on mobile) -->
<nav class="navbar">
  <a href="/">Home</a>
  <a href="/pages/pit_procedures.html">Pit Procedures</a>
  <a href="/pages/ondeck.html">Ondeck</a>
  <a href="/pages/match_scouting.html">Match Scouting</a>
  <a href="/pages/pit_scouting.html">Pit Scouting</a>
  <a href="/pages/team_summary.html" class="admin-only">Team Summary</a>
  <a href="/pages/match_simulator.html">Match Simulator</a>
  <a href="/pages/rankings.html" class="admin-only">Rankings</a>
  <a href="/pages/raw_match.html">Raw Match Data</a>
  <a href="/pages/raw_match_edit.html" class="admin-only">Raw Match Data Edit</a>
  <a href="/pages/raw_pit.html">Raw Pit Data</a>
  <a href="/pages/raw_pit_edit.html" class="admin-only">Raw Pit Data Edit</a>
  <a href="/pages/battery_manager.html">Battery Manager</a>
  <a href="/pages/csv_upload.html" class="admin-only">CSV Upload</a>
  <a href="/pages/config_creator.html">Config Creator</a>
  <a href="/pages/admin.html" class="admin-only">User Management</a>
  <a href="/pages/logout.html">Logout</a>
</nav>
<div class="container admin-only">
<div class="container">
  <h1>Rankings</h1>
  <div class="form-row">
    <label>Option</label>
    <div class="form-controls">
      <select id="opt"></select>
      <input id="minMatches" type="number" placeholder="Min Matches" value="3" min="1" style="width: 100px;">
      <input id="searchTeam" type="number" placeholder="Team Filter" style="width: 100px;">
      <button id="go" class="btn">Load</button>
    </div>
  </div>
  <div id="chartContainer" style="height: 300px; margin-bottom: 20px; display: none;">
    <canvas id="rankChart"></canvas>
  </div>
  <table id="rank" class="table"></table>
</div>
</div>
<footer>FRC 4123 Scouting • Config-driven • SQLite</footer>

<script>
let currentChart = null;
async function loadOptions(){
  const conf = await fetch('/api/config').then(r=>r.json());
  const sel = document.getElementById('opt');
  sel.innerHTML = '';
  const keys = Object.keys(conf.rankings_options||{});
  keys.forEach(k=> sel.appendChild(new Option(k,k)));
}
async function go(){
  const opt = document.getElementById('opt').value;
  const minMatches = document.getElementById('minMatches').value || 0;
  const teamFilter = document.getElementById('searchTeam').value;
  
  let url = `/api/rankings?option=${encodeURIComponent(opt)}`;
  if (minMatches > 0) url += `&min_matches=${minMatches}`;
  if (teamFilter) url += `&team=${teamFilter}`;
  
  const r = await fetch(url).then(r=>r.json());
  const tbl = document.getElementById('rank'); 
  tbl.innerHTML='';
  
  const rows = r.rows||[];
  if (!rows.length){ 
    tbl.innerHTML='<tr><td>No data</td></tr>'; 
    document.getElementById('chartContainer').style.display = 'none';
    return; 
  }
  
  // Create chart
  createRankingsChart(rows, r.description);
  
  const head = document.createElement('tr'); 
  Object.keys(rows[0]).forEach(k=>{ 
    const th=document.createElement('th'); 
    th.textContent=k; 
    head.appendChild(th); 
  }); 
  tbl.appendChild(head);
  
  rows.forEach(row=>{
    const tr=document.createElement('tr'); 
    Object.values(row).forEach(v=>{ 
      const td=document.createElement('td'); 
      td.textContent = (typeof v==='object')? JSON.stringify(v): String(v); 
      tr.appendChild(td); 
    }); 
    tbl.appendChild(tr);
  });
}

function createRankingsChart(data, title) {
  const ctx = document.getElementById('rankChart').getContext('2d');
  if (currentChart) currentChart.destroy();
  
  // Prepare data for chart (top 10 teams)
  const topTeams = data.slice(0, 40);
  const teamNumbers = topTeams.map(item => item.team_number);
  const metricValues = topTeams.map(item => parseFloat(item.metric_value) || 0);
  
  currentChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: teamNumbers,
      datasets: [{
        label: title,
        data: metricValues,
        backgroundColor: 'rgba(54, 162, 235, 0.5)',
        borderColor: 'rgba(54, 162, 235, 1)',
        borderWidth: 1
      }]
    },
    options: {
      responsive: true,
      plugins: {
        title: {
          display: true,
          text: title
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          title: {
            display: true,
            text: 'Metric Value'
          }
        },
        x: {
          title: {
            display: true,
            text: 'Team Number'
          }
        }
      }
    }
  });
  
  document.getElementById('chartContainer').style.display = 'block';
}

document.getElementById('go').addEventListener('click', go);
loadOptions();
</script>

</body></html>
