<!doctype html>
<html><head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Raw Match Data Edit</title>
<link rel="stylesheet" href="/css/style.css"/>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script src="/js/auth.js"></script>
</head>
<body>
<div class="mobile-nav">
  <button class="hamburger" onclick="toggleMenu()">☰</button>
  <div class="mobile-menu" id="mobileMenu">
    <button class="mobile-menu-close" onclick="toggleMenu()">×</button>
    <a href="/" onclick="toggleMenu()">Home</a>
    <a href="/pages/match_scouting.html" onclick="toggleMenu()">Match Scouting</a>
    <a href="/pages/pit_scouting.html" onclick="toggleMenu()">Pit Scouting</a>
    <a href="/pages/team_summary.html" onclick="toggleMenu()">Team Summary</a>
    <a href="/pages/match_simulator.html" onclick="toggleMenu()">Match Simulator</a>
    <a href="/pages/rankings.html" onclick="toggleMenu()">Rankings</a>
    <a href="/pages/raw_match.html" onclick="toggleMenu()">Raw Match Data</a>
    <a href="/pages/raw_match_edit.html" onclick="toggleMenu()">Raw Match Data Edit</a>
    <a href="/pages/raw_pit.html" onclick="toggleMenu()">Raw Pit Data</a>
    <a href="/pages/raw_pit_edit.html" onclick="toggleMenu()">Raw Pit Data Edit</a>
    <a href="/pages/csv_upload.html" onclick="toggleMenu()">CSV Upload</a>
    <a href="/pages/config_creator.html" onclick="toggleMenu()">Config Creator</a>
  </div>
</div>
<script>
// Mobile menu functionality
function toggleMenu() {
  const menu = document.getElementById('mobileMenu');
  const isOpening = !menu.classList.contains('open');
  menu.classList.toggle('open');
  document.body.classList.toggle('menu-open', isOpening);
  if (isOpening) {
    setTimeout(() => {
      menu.scrollTop = 0;
    }, 50);
  }
}

// Close menu when clicking outside
document.addEventListener('click', function(event) {
  const menu = document.getElementById('mobileMenu');
  const hamburger = document.querySelector('.hamburger');
  if (menu.classList.contains('open') && 
      !menu.contains(event.target) && 
      event.target !== hamburger) {
    toggleMenu();
  }
});

// Close menu on escape key
document.addEventListener('keydown', function(event) {
  if (event.key === 'Escape') {
    const menu = document.getElementById('mobileMenu');
    if (menu.classList.contains('open')) {
      toggleMenu();
    }
  }
});

// Prevent background scrolling when menu is open
document.addEventListener('touchmove', function(event) {
  const menu = document.getElementById('mobileMenu');
  if (menu.classList.contains('open')) {
    if (!menu.contains(event.target)) {
      event.preventDefault();
    }
  }
}, { passive: false });
</script>
<nav class="navbar">
  <a href="/">Home</a>
  <a href="/pages/match_scouting.html">Match Scouting</a>
  <a href="/pages/pit_scouting.html">Pit Scouting</a>
  <a href="/pages/team_summary.html">Team Summary</a>
  <a href="/pages/match_simulator.html">Match Simulator</a>
  <a href="/pages/rankings.html">Rankings</a>
  <a href="/pages/raw_match.html">Raw Match Data</a>
  <a href="/pages/raw_match_edit.html">Raw Match Data Edit</a>
  <a href="/pages/raw_pit.html">Raw Pit Data</a>
  <a href="/pages/raw_pit_edit.html">Raw Pit Data Edit</a>
  <a href="/pages/csv_upload.html">CSV Upload</a>
  <a href="/pages/config_creator.html">Config Creator</a>
</nav>
<div class="container">
  <div class="container admin-only"></div>
  <h1>Raw Match Data Edit</h1>
  <div class="form-row"><label>Show</label><div class="form-controls"><input id="limit" type="number" value="50"/><button id="load" class="btn">Load</button></div></div>
  <div class="form-row"><a class="btn" href="/api/export/matches.csv">Export CSV</a></div>
  <table id="tbl" class="table"></table>
  <div class="center"><button id="more" class="btn">Load More</button></div>
  </div>
</div>
<footer>FRC 4123 Scouting • Config-driven • SQLite</footer>

<script>
let offset = 0;
function jsonArea(obj){ const ta=document.createElement('textarea'); ta.value=JSON.stringify(obj,null,2); ta.style.width='100%'; ta.rows=8; return ta; }

// Get auth token from localStorage and create headers
function getAuthHeaders() {
    const token = localStorage.getItem('authToken');
    return token ? { 'Authorization': token } : {};
}

async function load(reset){
  const limit = Number(document.getElementById('limit').value||50);
  if (reset){ offset = 0; document.getElementById('tbl').innerHTML=''; }
  
  // Add Authorization header to the request
  const rows = await fetch(`/api/matches?limit=${limit}&offset=${offset}`, {
    headers: getAuthHeaders()
  }).then(r=>r.json());
  
  const tbl = document.getElementById('tbl');
  if (!tbl.querySelector('th')){
    const head = document.createElement('tr');
    ['ID','Created','Pre (edit)','Auto (edit)','Teleop (edit)','Endgame (edit)','Misc (edit)','Ops'].forEach(h=>{ const th=document.createElement('th'); th.textContent=h; head.appendChild(th); });
    tbl.appendChild(head);
  }
  rows.forEach(r=>{
    const tr=document.createElement('tr');
    const pre = jsonArea(r.pre_match_json);
    const auto = jsonArea(r.auto_json);
    const tele = jsonArea(r.teleop_json);
    const endg = jsonArea(r.endgame_json);
    const misc = jsonArea(r.misc_json);
    const ops = document.createElement('div');
    const save = document.createElement('button'); save.className='btn'; save.textContent='Save';
    save.onclick = async ()=>{
      const body = { pre_match_json: JSON.parse(pre.value), auto_json: JSON.parse(auto.value), teleop_json: JSON.parse(tele.value), endgame_json: JSON.parse(endg.value), misc_json: JSON.parse(misc.value) };
      await fetch(`/api/matches/${r.id}`, {
        method:'PUT', 
        headers: {
          'Content-Type':'application/json',
          ...getAuthHeaders()  // Add auth header
        }, 
        body: JSON.stringify(body)
      });
      save.textContent='Saved';
      setTimeout(()=>save.textContent='Save',1000);
    };
    const del = document.createElement('button'); del.className='btn btn-red'; del.textContent='Delete';
    del.onclick = async ()=>{ 
      await fetch(`/api/matches/${r.id}`, {
        method:'DELETE',
        headers: getAuthHeaders()  // Add auth header
      }); 
      tr.remove(); 
    };
    ops.append(save, del);
    tr.innerHTML = `<td>${r.id}</td><td>${r.created_at||''}</td>`;
    const tds = ['pre','auto','tele','endg','misc'].map(()=>document.createElement('td'));
    tds[0].appendChild(pre); tds[1].appendChild(auto); tds[2].appendChild(tele); tds[3].appendChild(endg); tds[4].appendChild(misc);
    const headTds = tr.innerHTML;
    tr.innerHTML = headTds;
    tds.forEach(td=>tr.appendChild(td));
    const tdOps = document.createElement('td'); tdOps.appendChild(ops); tr.appendChild(tdOps);
    tbl.appendChild(tr);
  });
  offset += rows.length;
}
document.getElementById('load').addEventListener('click', ()=>load(true));
document.getElementById('more').addEventListener('click', ()=>load(false));
load(true);
</script>

</body></html>