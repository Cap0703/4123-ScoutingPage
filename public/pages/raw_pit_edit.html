<!doctype html>
<html><head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Raw Pit Data Edit</title>
<link rel="stylesheet" href="/css/style.css"/>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
</head>
<body>
<nav class="navbar">
  <a href="/">Home</a>
  <a href="/pages/match_scouting.html">Match Scouting</a>
  <a href="/pages/pit_scouting.html">Pit Scouting</a>
  <a href="/pages/team_summary.html">Team Summary</a>
  <a href="/pages/match_simulator.html">Match Simulator</a>
  <a href="/pages/rankings.html">Rankings</a>
  <a href="/pages/raw_match.html">Raw Match Data</a>
  <a href="/pages/raw_match_edit.html">Raw Match Data Edit</a>
  <a href="/pages/raw_pit.html">Raw Pit Data</a>
  <a href="/pages/raw_pit_edit.html">Raw Pit Data Edit</a>
</nav>
<div class="container">
  <h1>Raw Pit Data Edit</h1>
  <div class="form-row"><label>Show</label><div class="form-controls"><input id="limit" type="number" value="50"/><button id="load" class="btn">Load</button></div></div>
  <div class="form-row"><a class="btn" href="/api/export/pits.csv">Export CSV</a></div>
  <table id="tbl" class="table"></table>
  <div class="center"><button id="more" class="btn">Load More</button></div>
</div>
<footer>FRC 4123 Scouting • Config-driven • SQLite</footer>

<script>
let offset = 0;
function jsonArea(obj){ const ta=document.createElement('textarea'); ta.value=JSON.stringify(obj,null,2); ta.style.width='100%'; ta.rows=8; return ta; }
async function load(reset){
  const limit = Number(document.getElementById('limit').value||50);
  if (reset){ offset = 0; document.getElementById('tbl').innerHTML=''; }
  
  try {
    const response = await fetch(`/api/pits?limit=${limit}&offset=${offset}`);
    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }
    const rows = await response.json();
    
    const tbl = document.getElementById('tbl');
    if (!tbl.querySelector('th')){
      const head = document.createElement('tr');
      ['ID','Created','Pit (edit)','Image Path','Ops'].forEach(h=>{ const th=document.createElement('th'); th.textContent=h; head.appendChild(th); });
      tbl.appendChild(head);
    }
    rows.forEach(r=>{
      const tr=document.createElement('tr');
      const pit = jsonArea(r.pit_json);
      const img = document.createElement('input'); img.value = r.image_path||''; img.style.width='100%';
      const save = document.createElement('button'); save.className='btn'; save.textContent='Save';
      save.onclick = async ()=>{
        try {
          const response = await fetch(`/api/pits/${r.id}`, {method:'PUT', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ pit_json: JSON.parse(pit.value), image_path: img.value })});
          if (response.ok) {
            save.textContent='Saved'; 
            setTimeout(()=>save.textContent='Save',1000);
          } else {
            throw new Error('Save failed');
          }
        } catch (error) {
          console.error('Error saving:', error);
          alert('Error saving data. Please check the console for details.');
        }
      };
      const del = document.createElement('button'); del.className='btn btn-red'; del.textContent='Delete';
      del.onclick = async ()=>{ 
        try {
          await fetch(`/api/pits/${r.id}`, {method:'DELETE'}); 
          tr.remove(); 
        } catch (error) {
          console.error('Error deleting:', error);
          alert('Error deleting data. Please check the console for details.');
        }
      };
      tr.innerHTML = `<td>${r.id}</td><td>${r.created_at||''}</td>`;
      const tdPit=document.createElement('td'); tdPit.appendChild(pit);
      const tdImg=document.createElement('td'); tdImg.appendChild(img);
      const tdOps=document.createElement('td'); tdOps.appendChild(save); tdOps.appendChild(del);
      tr.appendChild(tdPit); tr.appendChild(tdImg); tr.appendChild(tdOps);
      tbl.appendChild(tr);
    });
    offset += rows.length;
  } catch (error) {
    console.error('Error loading pit data:', error);
    alert('Error loading pit data. Please check the console for details.');
  }
}
document.getElementById('load').addEventListener('click', ()=>load(true));
document.getElementById('more').addEventListener('click', ()=>load(false));
load(true);
</script>

</body></html>